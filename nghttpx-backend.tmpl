{{ range $upstream := .Upstreams -}}
# {{ $upstream.Name }}
{{ range $backend := $upstream.Backends -}}
backend={{ $backend.Address }},{{ $backend.Port }};{{ $upstream.Host }}{{ $upstream.Path }};proto={{ $backend.Protocol }}{{ if $backend.TLS }};tls{{ end }}{{ if $backend.SNI }};sni={{ $backend.SNI }}{{ end }}{{ if $backend.DNS }};dns{{ end }};affinity={{ $backend.Affinity }}{{ if eq $backend.Affinity "cookie" }}{{ if $backend.AffinityCookieName }};affinity-cookie-name={{ $backend.AffinityCookieName }}{{ end }}{{ if $backend.AffinityCookiePath }};affinity-cookie-path={{ $backend.AffinityCookiePath }}{{ end }};affinity-cookie-secure={{ $backend.AffinityCookieSecure }}{{ end }}{{ if ne $backend.Affinity $upstream.Affinity }};affinity={{ $upstream.Affinity }}{{ end }}{{ if eq $upstream.Affinity "cookie" }}{{ if $upstream.AffinityCookieName }};affinity-cookie-name={{ $upstream.AffinityCookieName }}{{ end }}{{ if $upstream.AffinityCookiePath }};affinity-cookie-path={{ $upstream.AffinityCookiePath }}{{ end }};affinity-cookie-secure={{ $upstream.AffinityCookieSecure }}{{ end }}{{ if $upstream.RedirectIfNotTLS }};redirect-if-not-tls{{ end }}{{ if $upstream.Mruby }};mruby={{ $upstream.Mruby.Path }}{{ end }}{{ if $upstream.ReadTimeout }};read-timeout={{ duration $upstream.ReadTimeout }}{{ end }}{{ if $upstream.WriteTimeout }};write-timeout={{ duration $upstream.WriteTimeout }}{{ end }}
{{ end -}}
{{ end }}
